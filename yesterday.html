<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Horse Racing ROI & Winners | Smart Racecards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="yesterday.css" />
</head>
<body>
  <nav class="main-navbar">
    <div class="navbar-inner">
      <a href="index.html" class="nav-brand">üèá Racecards</a>
      <div class="nav-links" id="navLinks">
        <a href="index.html" class="nav-link">Home</a>
        <a href="tips.html" class="nav-link">Tips</a>
         <a href="yesterday.html" class="nav-link nav-link-active">Yesterday</a>
         <a href="custom-score.html" class="nav-link">Custom Score</a>
         <a href="about.html" class="nav-link">About</a>
      </div>
      <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>
  <div class="container">
    <h1>Selections, Winners & ROI Breakdown</h1>
    <div class="roi-summary">
      <h2>ROI Summary</h2>
      <p><b>Total races processed:</b> <span id="total-races">...</span></p>
      <p><b>Total staked:</b> <span id="total-staked">...</span></p>
      <p><b>Total returned:</b> <span id="total-returned">...</span></p>
      <p><b>Overall ROI:</b> <span id="roi-all">...</span>%</p>
    </div>
    <div class="roi-tables">
      <h3>ROI by Course</h3>
      <div class="table-responsive"><table id="roi-by-course"></table></div>
      <h3>ROI by Race Type</h3>
      <div class="table-responsive"><table id="roi-by-type"></table></div>
      <h3>ROI by Race Class</h3>
      <div class="table-responsive"><table id="roi-by-class"></table></div>
    </div>
    <div class="winners-table">
      <h2>All Winners</h2>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Course</th><th>Off</th><th>Tip</th><th>Odds</th><th>SP</th><th>Win Return</th><th>Race</th>
            </tr>
          </thead>
          <tbody id="winners-rows">
            <!-- WINNERS ROWS GO HERE -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    // CSV fetch and parse
    const CSV_PATH = 'data/roi_full_breakdown.csv';
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const cells = line.split(',').map(c => c.trim());
        let obj = {};
        headers.forEach((h, i) => obj[h] = cells[i]);
        return obj;
      });
    }

    function groupBy(arr, key) {
      return arr.reduce((acc, x) => {
        (acc[x[key]] = acc[x[key]] || []).push(x);
        return acc;
      }, {});
    }

    fetch(CSV_PATH)
      .then(resp => resp.text())
      .then(text => {
        const data = parseCSV(text);

        // -------- ROI SUMMARY --------
        const totalRaces = data.length;
        const totalStaked = data.reduce((a, r) => a + (parseFloat(r['staked']||'1') || 0), 0);
        const totalReturned = data.reduce((a, r) => a + (parseFloat(r['win_return']||'0') || 0), 0);
        const roiAll = totalStaked ? (((totalReturned - totalStaked) / totalStaked) * 100).toFixed(2) : '0.00';

        document.getElementById('total-races').textContent = totalRaces;
        document.getElementById('total-staked').textContent = '¬£' + totalStaked.toFixed(2);
        document.getElementById('total-returned').textContent = '¬£' + totalReturned.toFixed(2);
        document.getElementById('roi-all').textContent = roiAll;

        // -------- ROI BY COURSE --------
        let courseData = groupBy(data, 'course');
        let html = `<tr><th>Course</th><th>Races</th><th>Staked</th><th>Returned</th><th>ROI (%)</th></tr>`;
        Object.entries(courseData).forEach(([course, rows]) => {
          const races = rows.length;
          const staked = rows.reduce((a, r) => a + (parseFloat(r['staked']||'1') || 0), 0);
          const returned = rows.reduce((a, r) => a + (parseFloat(r['win_return']||'0') || 0), 0);
          const roi = staked ? (((returned - staked) / staked) * 100).toFixed(2) : '0.00';
          html += `<tr${roi > 0 ? ' class="win-row"' : ''}><td>${course}</td><td>${races}</td><td>¬£${staked.toFixed(2)}</td><td>¬£${returned.toFixed(2)}</td><td>${roi}</td></tr>`;
        });
        document.getElementById('roi-by-course').innerHTML = html;

        // -------- ROI BY TYPE --------
        let typeData = groupBy(data, 'type');
        html = `<tr><th>Type</th><th>Races</th><th>Staked</th><th>Returned</th><th>ROI (%)</th></tr>`;
        Object.entries(typeData).forEach(([type, rows]) => {
          const races = rows.length;
          const staked = rows.reduce((a, r) => a + (parseFloat(r['staked']||'1') || 0), 0);
          const returned = rows.reduce((a, r) => a + (parseFloat(r['win_return']||'0') || 0), 0);
          const roi = staked ? (((returned - staked) / staked) * 100).toFixed(2) : '0.00';
          html += `<tr${roi > 0 ? ' class="win-row"' : ''}><td>${type}</td><td>${races}</td><td>¬£${staked.toFixed(2)}</td><td>¬£${returned.toFixed(2)}</td><td>${roi}</td></tr>`;
        });
        document.getElementById('roi-by-type').innerHTML = html;

        // -------- ROI BY CLASS --------
        let classData = groupBy(data, 'class');
        html = `<tr><th>Class</th><th>Races</th><th>Staked</th><th>Returned</th><th>ROI (%)</th></tr>`;
        Object.entries(classData).forEach(([cls, rows]) => {
          const races = rows.length;
          const staked = rows.reduce((a, r) => a + (parseFloat(r['staked']||'1') || 0), 0);
          const returned = rows.reduce((a, r) => a + (parseFloat(r['win_return']||'0') || 0), 0);
          const roi = staked ? (((returned - staked) / staked) * 100).toFixed(2) : '0.00';
          html += `<tr${roi > 0 ? ' class="win-row"' : ''}><td>${cls}</td><td>${races}</td><td>¬£${staked.toFixed(2)}</td><td>¬£${returned.toFixed(2)}</td><td>${roi}</td></tr>`;
        });
        document.getElementById('roi-by-class').innerHTML = html;

        // -------- WINNERS TABLE --------
        const winners = data.filter(r => r.position === '1' || r.position === '1.0' || r.win_return > 0);
        winners.sort((a, b) => new Date(b.date) - new Date(a.date) || a.course.localeCompare(b.course));
        let winHtml = '';
        winners.forEach(r => {
          winHtml += `<tr class="win-row">
            <td>${r.date}</td>
            <td>${r.course}</td>
            <td>${r.off_time || ''}</td>
            <td>${r.tip}</td>
            <td>${r.tip_odds}</td>
            <td>${r.sp_dec || ''}</td>
            <td>¬£${parseFloat(r.win_return||0).toFixed(2)}</td>
            <td>${r.race}</td>
          </tr>`;
        });
        document.getElementById('winners-rows').innerHTML = winHtml;

      })
      .catch(err => {
        document.querySelector('.container').innerHTML = `<h1>Error</h1><p>Could not load <code>${CSV_PATH}</code>: ${err}</p>`;
      });
  </script>
</body>
</html>
